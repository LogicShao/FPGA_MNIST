# MNIST INT8 推理代码

## 文件说明

- `main.c`: INT8定点推理主程序
- `model_weights.h`: 量化后的模型权重（由Python脚本自动生成）
- `test_image.h`: 测试图片数据

## 量化推理原理

### 量化策略

训练脚本使用**对称量化**生成INT8权重：
- 每层权重和偏置都有独立的缩放因子（SCALE_W1/B1/W2/B2）
- 量化公式：`INT8_value = float_value * scale`
- 权重范围：[-127, 127]

### 推理流程

**INT8定点推理**保持简单高效：

1. **输入层**：MNIST图片归一化到INT8范围（0-127）
2. **第一层（FC + ReLU）**：
   - 矩阵乘法：`sum = W1 * input + B1`
   - ReLU激活：`sum = max(0, sum)`
   - 右移缩放：`sum >> LAYER1_SHIFT`
   - 截断到INT8
3. **第二层（FC）**：
   - 矩阵乘法：`sum = W2 * hidden + B2`
   - 保持INT32用于argmax
4. **输出**：找到最大值对应的索引

## 关键参数调整

### LAYER1_SHIFT（重要）

**作用：** 控制第一层输出的缩放，避免INT32累加结果溢出INT8范围。

**默认值：** `8`（右移8位，相当于除以256）

**何时需要调整：**

如果推理结果不正确或者得分异常，可能需要调整此参数。

**调整方法：**

1. **编译并运行测试**
   ```bash
   gcc main.c -o mnist_test
   ./mnist_test
   ```

2. **观察详细得分输出**
   ```
   详细得分: [1234 -567 8901 456 -123 234 567 -890 345 678]
   预测结果: 2
   ```

3. **根据得分范围调整**

   | 得分范围特征 | LAYER1_SHIFT值 | 说明 |
   |------------|---------------|------|
   | 数值过大（>100000） | 增大（9或10） | 第一层输出过大，需要更多缩放 |
   | 数值过小（<100） | 减小（6或7） | 缩放过度，损失精度 |
   | 分布合理（100-10000） | 保持当前值 | 推理正常 |

4. **测试验证**
   - 调整后重新编译测试
   - 确认预测结果与真实标签一致
   - 得分分布应该有明显差异（最大值显著大于其他值）

## 示例输出

### 正常推理输出

```
=== PC 端 MNIST 推理测试 ===
测试图片真实标签: 7
详细得分: [1234 -567 8901 456 -123 234 567 -890 345 12345]
预测结果: 9
结果异常！
```

如果结果异常，按照上述方法调整 `LAYER1_SHIFT`。

### 正确推理输出

```
=== PC 端 MNIST 推理测试 ===
测试图片真实标签: 7
详细得分: [823 -245 1567 342 -98 187 456 8934 289 512]
预测结果: 7
测试通过！逻辑正常。
```

## 与新量化策略的兼容性

### v2.0 优化版训练脚本改进

新的训练脚本使用**对称量化**：
- 自动计算每层最优缩放因子
- 量化误差降低50%以上
- `model_weights.h` 包含SCALE_XX宏定义（供参考）

### 推理代码简化策略

为了保持FPGA资源占用最小：
- **不使用浮点运算**
- **不进行反量化**
- 直接使用INT8定点运算
- 通过 `LAYER1_SHIFT` 参数调整缩放

这种策略在保持高准确率的同时，极大简化了硬件实现。

## 编译选项

### PC端测试

```bash
# Linux/Mac
gcc main.c -o mnist_test
./mnist_test

# Windows (MinGW)
gcc main.c -o mnist_test.exe
mnist_test.exe
```

### FPGA端（Nios II）

参考项目主Makefile配置，通常需要：
```bash
nios2-elf-gcc main.c -o mnist.elf
```

## 故障排查

### 问题1：预测结果始终错误

**原因：** LAYER1_SHIFT参数不匹配量化范围

**解决：**
1. 查看详细得分
2. 按照上述方法调整LAYER1_SHIFT
3. 典型值范围：6-10

### 问题2：得分全部为负数或零

**原因：** 缩放过度或ReLU过早截断

**解决：**
1. 减小LAYER1_SHIFT（试试6或7）
2. 检查test_image.h中的图片数据是否正确归一化

### 问题3：编译错误：找不到model_weights.h

**原因：** 尚未运行训练脚本生成权重文件

**解决：**
```bash
cd ../../model_tools
python v1/train_export.py --mode all
```

## 性能优化建议

1. **FPGA实现时**：考虑并行化矩阵乘法
2. **内存优化**：复用hidden_output缓冲区
3. **定点优化**：根据实际硬件选择合适的位宽

## 参考

- 训练脚本：`model_tools/v1/train_export.py`
- 量化算法：对称量化（Symmetric Quantization）
- 网络结构：784 -> 32 -> 10 (MLP)
